schemaVersion: 2.2.0
metadata:
  name: java-21-development
  displayName: Java 21 Development Environment
  description: Development environment with Java 21, Git, Maven, and Gradle support
  tags:
    - Java
    - Java 21
    - Git
    - Maven
    - Gradle
  projectType: Java
  language: Java
  version: 1.0.0

components:
  # Universal Developer Image with Java
  - name: tools
    container:
      image: registry.redhat.io/devspaces/udi-rhel8:latest
      memoryLimit: 4Gi
      memoryRequest: 1Gi
      cpuLimit: 2000m
      cpuRequest: 500m
      mountSources: true
      endpoints:
        - name: web-app
          targetPort: 8080
          exposure: public
          protocol: http
      env:
        - name: MAVEN_OPTS
          value: '-Xmx2g'
        - name: GRADLE_OPTS
          value: '-Xmx2g'
      volumeMounts:
        - name: m2
          path: /home/user/.m2
        - name: gradle
          path: /home/user/.gradle

  # Maven configuration volume
  - name: m2
    volume:
      size: 1Gi

  # Gradle configuration volume
  - name: gradle
    volume:
      size: 1Gi

commands:
  # Setup Java environment - Install Java 21
  - id: setup-java
    exec:
      component: tools
      commandLine: |
        #!/bin/bash
        echo "Setting up Java 21 environment..."
        
        # Check if Java 21 is already installed
        if [ -d "$HOME/.sdkman/candidates/java/21.0.5-tem" ]; then
          echo "Java 21 already installed"
        else
          # Install SDKMAN if not present
          if [ ! -d "$HOME/.sdkman" ]; then
            echo "Installing SDKMAN..."
            curl -s "https://get.sdkman.io" | bash
            source "$HOME/.sdkman/bin/sdkman-init.sh"
          else
            source "$HOME/.sdkman/bin/sdkman-init.sh"
          fi
        
          # Install Java 21 (Temurin)
          echo "Installing Java 21..."
          sdk install java 21.0.5-tem
          sdk default java 21.0.5-tem
        fi
        
        # Set up environment
        source "$HOME/.sdkman/bin/sdkman-init.sh"
        export JAVA_HOME="$HOME/.sdkman/candidates/java/current"
        export PATH="$JAVA_HOME/bin:$PATH"
        
        # Add to bashrc for persistence
        if ! grep -q "sdkman-init.sh" ~/.bashrc; then
          echo 'export SDKMAN_DIR="$HOME/.sdkman"' >> ~/.bashrc
          echo '[[ -s "$HOME/.sdkman/bin/sdkman-init.sh" ]] && source "$HOME/.sdkman/bin/sdkman-init.sh"' >> ~/.bashrc
        fi
        
        echo "Java version:"
        java -version
        echo ""
        echo "JAVA_HOME: $JAVA_HOME"
      workingDir: ${PROJECT_SOURCE}
      group:
        kind: build

  # Verify Java installation
  - id: verify-java
    exec:
      component: tools
      commandLine: |
        echo "Java version:"
        java -version
        echo ""
        echo "JAVA_HOME: $JAVA_HOME"
        echo "Java binary location: $(which java)"
      workingDir: ${PROJECT_SOURCE}
      group:
        kind: test

  # Verify Git installation
  - id: verify-git
    exec:
      component: tools
      commandLine: |
        echo "Git version:"
        git --version
      workingDir: ${PROJECT_SOURCE}
      group:
        kind: test

  # Build with Maven
  - id: maven-build
    exec:
      component: tools
      commandLine: mvn clean install
      workingDir: ${PROJECT_SOURCE}
      group:
        kind: build

  # Build with Gradle
  - id: gradle-build
    exec:
      component: tools
      commandLine: ./gradlew build
      workingDir: ${PROJECT_SOURCE}
      group:
        kind: build

  # Gradle clean build
  - id: gradle-clean-build
    exec:
      component: tools
      commandLine: ./gradlew clean build
      workingDir: ${PROJECT_SOURCE}
      group:
        kind: build

  # Run Gradle tests
  - id: gradle-test
    exec:
      component: tools
      commandLine: ./gradlew test
      workingDir: ${PROJECT_SOURCE}
      group:
        kind: test

  # Run application
  - id: run-app
    exec:
      component: tools
      commandLine: java -jar target/*.jar
      workingDir: ${PROJECT_SOURCE}
      group:
        kind: run
        isDefault: true

  # Maven clean
  - id: maven-clean
    exec:
      component: tools
      commandLine: mvn clean
      workingDir: ${PROJECT_SOURCE}
      group:
        kind: build

  # Gradle wrapper update
  - id: gradle-wrapper-update
    exec:
      component: tools
      commandLine: ./gradlew wrapper --gradle-version=9.2.0
      workingDir: ${PROJECT_SOURCE}
      group:
        kind: build

events:
  # Post-start commands (runs after workspace starts)
  postStart:
    - setup-java
    - verify-git
    - verify-java